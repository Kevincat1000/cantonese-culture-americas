<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Map (3D Routes)</title>

  <link rel="stylesheet" href="styles.css" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    /* 不影响你全站 styles.css，只加地图必须的 */
    .map-wrap{
      max-width: 1100px;
      margin: 28px auto 60px auto;
      padding: 0 20px;
    }
    #map{
      width: 100%;
      height: 650px;
      border: 1px solid #000;
    }

    /* 自定义 Marker（更像项目地图点） */
    .mkr{
      width: 12px; height: 12px;
      border-radius: 999px;
      background: #111;
      border: 2px solid #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
    }
    .mkr.blue{ background:#3d85c6; }
    .mkr.gray{ background:#666666; }

    .popup{
      font-family: "Times New Roman", Georgia, serif;
      min-width: 220px;
    }
    .popup .t{
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 6px 0;
    }
    .popup .s{
      font-size: 14px;
      color: #444;
      margin: 0 0 8px 0;
      line-height: 1.35;
    }
    .popup .c{
      font-size: 13px;
      color: #666;
      margin: 0;
    }
  </style>
</head>

<body>
  <!-- 你全站统一 header（保留 dropdown） -->
  <header class="site-header">
    <h1 class="site-title">Cantonese Culture in the Americas</h1>
    <nav class="site-nav">
      <a href="index.html">Home</a>

      <div class="dropdown">
        <button type="button" class="active" aria-haspopup="true" aria-expanded="false">Timeline</button>
        <div class="dropdown-menu" role="menu">
          <a href="timeline-phase1.html">Phase 1</a>
          <a href="timeline-phase2.html">Phase 2</a>
          <a href="timeline-phase3.html">Phase 3</a>
          <a href="timeline-phase4.html">Phase 4</a>
          <a class="active" href="map.html">Map</a>
        </div>
      </div>

      <a href="research.html">Research</a>
      <a href="archives.html">Archives</a>
      <a href="resources.html">Resources</a>
    </nav>
  </header>

  <main class="map-wrap">
    <h2 class="page-title">Map</h2>
    <p class="page-subtitle">
      3D Mapbox map with animated routes (maritime + flight).
    </p>

    <div id="map" aria-label="Interactive 3D map"></div>

    <div class="footer">© Cantonese Culture in the Americas</div>
  </main>

  <script src="nav.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <script>
    // =========================
    // 1) CONFIG
    // =========================
    mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN_HERE";

    // 你的 Studio 样式（你说改成 v0 的那个）
    const STYLE_URL = "mapbox://styles/kevincat100/cmjneo20k000v01sxghqb6aqr";

    // 初始视角：center 到 Cambodia 附近（你要求）
    const map = new mapboxgl.Map({
      container: "map",
      style: STYLE_URL,
      center: [104.9, 12.6],  // Cambodia-ish
      zoom: 3.4,
      pitch: 58,
      bearing: 0,
      antialias: true
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), "top-right");

    // =========================
    // 2) DATA: POINTS
    // 规则：主标题=过去名字；副标题=现在名字（没有就空）；国家
    // =========================
    const points = [
      {
        id: "siyi",
        past: "Si Yi",
        now: "Sze Yup region of Guangdong",
        country: "China",
        coord: [112.5, 22.8],
        color: "blue"
      },
      {
        id: "ayutthaya",
        past: "Ayutthaya Kingdom",
        now: "Ayutthaya",
        country: "Thailand",
        coord: [100.57, 14.35],
        color: "blue"
      },
      {
        id: "hatien",
        past: "Hà Tiên",
        now: "",
        country: "Vietnam",
        coord: [104.49, 10.39],
        color: "blue"
      },
      {
        id: "saigon",
        past: "Saigon",
        now: "Ho Chi Minh City",
        country: "Vietnam",
        coord: [106.63, 10.82],
        color: "blue"
      },
      {
        id: "penang",
        past: "Penang",
        now: "",
        country: "Malaysia",
        coord: [100.33, 5.41],
        color: "blue"
      },
      {
        id: "singapore",
        past: "Singapore",
        now: "",
        country: "Singapore",
        coord: [103.82, 1.35],
        color: "blue"
      },
      {
        id: "hongkong",
        past: "Hong Kong",
        now: "",
        country: "China",
        coord: [114.17, 22.32],
        color: "gray"
      },
      {
        id: "hawaii",
        past: "Hawaiʻi",
        now: "",
        country: "USA",
        coord: [-157.86, 21.31],
        color: "gray"
      },
      {
        id: "sf",
        past: "San Francisco",
        now: "",
        country: "USA",
        coord: [-122.42, 37.77],
        color: "blue"
      },
      {
        id: "california",
        past: "California",
        now: "",
        country: "USA",
        coord: [-120.0, 36.8],
        color: "gray"
      }
    ];

    function popupHTML(p){
      const sub = p.now ? `<div class="s">${p.now}</div>` : "";
      return `
        <div class="popup">
          <div class="t">${p.past}</div>
          ${sub}
          <div class="c">${p.country}</div>
        </div>
      `;
    }

    // =========================
    // 3) DATA: ROUTES
    // 蓝色：海路/迁徙水路（#3d85c6）+ 流动效果
    // 灰色：飞行航线（#666666）直接向东穿越太平洋，经过夏威夷附近
    // =========================

    // 3.1 海路：Si Yi → Ayutthaya（绕过 Ca Mau，不走新加坡/马六甲）
    // 做法：给一串“水上点”靠近南海—泰国湾方向（不走马六甲）
    const route_blue_1 = [
      get("siyi"),
      [112.0, 20.2],   // South China Sea
      [110.6, 16.5],   // mid sea
      [109.8, 12.0],   // near Vietnam coast
      [102.8, 10.6],   // Gulf of Thailand entry
      [100.7, 12.2],   // up gulf
      get("ayutthaya")
    ];

    // 3.2 海路：Ayutthaya → Hà Tiên → Saigon
    const route_blue_2 = [
      get("ayutthaya"),
      [101.5, 12.6],   // gulf water
      [103.1, 10.6],
      get("hatien"),
      [105.5, 10.5],
      get("saigon")
    ];

    // 3.3 海路：Si Yi → Penang → Singapore
    const route_blue_3 = [
      get("siyi"),
      [110.5, 18.2],   // SCS
      [108.5, 11.0],
      [103.0, 7.5],
      get("penang"),
      get("singapore")
    ];

    // 3.4 蓝线：Si Yi → San Francisco（直接跨太平洋）
    const route_blue_4 = [
      get("siyi"),
      [150.0, 28.0],   // pacific mid (eastbound)
      [-170.0, 30.0],  // cross dateline (no date-change worry)
      [-140.0, 35.0],
      get("sf")
    ];

    // 3.5 灰色飞行：Vietnam → California（向东跨太平洋，经 Hawaiʻi 附近）
    const route_gray_1 = [
      get("saigon"),
      [140.0, 22.0],
      [-175.0, 25.0],
      get("hawaii"),
      [-135.0, 33.0],
      get("california")
    ];

    // 3.6 灰色飞行：Hong Kong → California（向东跨太平洋，经 Hawaiʻi 附近）
    const route_gray_2 = [
      get("hongkong"),
      [150.0, 28.0],
      [-175.0, 30.0],
      get("hawaii"),
      [-135.0, 34.0],
      get("california")
    ];

    function get(id){
      const p = points.find(x => x.id === id);
      return p.coord;
    }

    // =========================
    // 4) MAP LOAD: 3D + ROUTES + MARKERS
    // =========================
    map.on("load", () => {
      // ---- 4.1 Add 3D terrain + sky (if your style supports raster-dem) ----
      // 给一个通用的 Mapbox DEM 源（不改你 Studio 样式的情况下也能用）
      if (!map.getSource("mapbox-dem")) {
        map.addSource("mapbox-dem", {
          type: "raster-dem",
          url: "mapbox://mapbox.mapbox-terrain-dem-v1",
          tileSize: 512,
          maxzoom: 14
        });
      }

      map.setTerrain({ source: "mapbox-dem", exaggeration: 1.2 });

      // sky layer
      if (!map.getLayer("sky")) {
        map.addLayer({
          id: "sky",
          type: "sky",
          paint: {
            "sky-type": "atmosphere",
            "sky-atmosphere-sun-intensity": 8
          }
        });
      }

      // optional fog (nice cinematic)
      if (map.setFog) {
        map.setFog({
          "range": [0.8, 8],
          "horizon-blend": 0.2
        });
      }

      // ---- 4.2 Add routes sources ----
      addRoute("route-blue-1", route_blue_1);
      addRoute("route-blue-2", route_blue_2);
      addRoute("route-blue-3", route_blue_3);
      addRoute("route-blue-4", route_blue_4);

      addRoute("route-gray-1", route_gray_1);
      addRoute("route-gray-2", route_gray_2);

      // ---- 4.3 Add route layers (thin + flowing) ----
      addFlowLine("route-blue-1", "#3d85c6", 2.2);
      addFlowLine("route-blue-2", "#3d85c6", 2.2);
      addFlowLine("route-blue-3", "#3d85c6", 2.2);
      addFlowLine("route-blue-4", "#3d85c6", 2.2);

      addFlowLine("route-gray-1", "#666666", 2.4);
      addFlowLine("route-gray-2", "#666666", 2.4);

      // ---- 4.4 Add markers ----
      points.forEach(p => {
        const el = document.createElement("div");
        el.className = "mkr " + (p.color === "gray" ? "gray" : "blue");

        new mapboxgl.Marker(el)
          .setLngLat(p.coord)
          .setPopup(new mapboxgl.Popup({ offset: 14 }).setHTML(popupHTML(p)))
          .addTo(map);
      });

      // ---- 4.5 Animate dashed flow ----
      animateDashes();
    });

    function addRoute(id, coords){
      map.addSource(id, {
        type: "geojson",
        data: {
          type: "Feature",
          properties: {},
          geometry: {
            type: "LineString",
            coordinates: coords
          }
        }
      });
    }

    function addFlowLine(sourceId, color, width){
      // 实线底（淡一点）
      map.addLayer({
        id: sourceId + "-base",
        type: "line",
        source: sourceId,
        layout: { "line-cap": "round", "line-join": "round" },
        paint: {
          "line-color": color,
          "line-width": width,
          "line-opacity": 0.28
        }
      });

      // 虚线（流动）
      map.addLayer({
        id: sourceId + "-dash",
        type: "line",
        source: sourceId,
        layout: { "line-cap": "round", "line-join": "round" },
        paint: {
          "line-color": color,
          "line-width": width,
          "line-opacity": 0.95,
          "line-dasharray": [2, 2],
          "line-translate": [0, 0]
        }
      });
    }

    // 让虚线“流动”：不断改变 dasharray 组合
    function animateDashes(){
      const dashSteps = [
        [0, 4, 3],
        [1, 4, 2],
        [2, 4, 1],
        [3, 4, 0]
      ];
      let step = 0;

      const dashLayerIds = [
        "route-blue-1-dash","route-blue-2-dash","route-blue-3-dash","route-blue-4-dash",
        "route-gray-1-dash","route-gray-2-dash"
      ];

      function tick(){
        const s = dashSteps[step];
        dashLayerIds.forEach(id => {
          if (map.getLayer(id)) map.setPaintProperty(id, "line-dasharray", s);
        });
        step = (step + 1) % dashSteps.length;
        requestAnimationFrame(tick);
      }
      tick();
    }
  </script>
</body>
</html>
